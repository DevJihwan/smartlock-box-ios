# SmartLockBox iOS ë¹Œë“œ ì˜¤ë¥˜ ìˆ˜ì • ê¸°ë¡
**ë‚ ì§œ:** 2025ë…„ 11ì›” 1ì¼  
**ì‘ì—…ì:** DevJihwan with Claude

---

## ğŸ“‹ ëª©ì°¨
1. [ê°œìš”](#ê°œìš”)
2. [ìˆ˜ì •ëœ íŒŒì¼ ëª©ë¡](#ìˆ˜ì •ëœ-íŒŒì¼-ëª©ë¡)
3. [ìƒì„¸ ìˆ˜ì • ë‚´ì—­](#ìƒì„¸-ìˆ˜ì •-ë‚´ì—­)
4. [ì£¼ìš” ê°œì„ ì‚¬í•­](#ì£¼ìš”-ê°œì„ ì‚¬í•­)
5. [ë¹Œë“œ ê²°ê³¼](#ë¹Œë“œ-ê²°ê³¼)

---

## ê°œìš”

SmartLockBox iOS ì•±ì˜ ë¹Œë“œ ì˜¤ë¥˜ë¥¼ ì „ë©´ ìˆ˜ì •í•˜ê³  ì½”ë“œ êµ¬ì¡°ë¥¼ ê°œì„ í–ˆìŠµë‹ˆë‹¤. ì£¼ìš” ë¬¸ì œëŠ” deprecated API ì‚¬ìš©, ëˆ„ë½ëœ ì¤‘ì•™ ìƒíƒœ ê´€ë¦¬ í´ë˜ìŠ¤, íƒ€ì… ë¶ˆì¼ì¹˜, ê·¸ë¦¬ê³  ë³µì¡í•œ SwiftUI í‘œí˜„ì‹ìœ¼ë¡œ ì¸í•œ ì»´íŒŒì¼ëŸ¬ íƒ€ì„ì•„ì›ƒì´ì—ˆìŠµë‹ˆë‹¤.

### ì´ˆê¸° ìƒíƒœ
- âŒ ë¹Œë“œ ì‹¤íŒ¨ (ë‹¤ìˆ˜ì˜ ì»´íŒŒì¼ ì˜¤ë¥˜)
- âŒ AppStateManager ëˆ„ë½
- âŒ Deprecated Screen Time API ì‚¬ìš©
- âŒ íƒ€ì… ë¶ˆì¼ì¹˜ ì˜¤ë¥˜

### ìµœì¢… ìƒíƒœ
- âœ… ë¹Œë“œ ì„±ê³µ
- âœ… ì¤‘ì•™í™”ëœ ìƒíƒœ ê´€ë¦¬ êµ¬í˜„
- âœ… ìµœì‹  API ì‚¬ìš©
- âœ… íƒ€ì… ì•ˆì •ì„± í™•ë³´

---

## ìˆ˜ì •ëœ íŒŒì¼ ëª©ë¡

### ìƒˆë¡œ ìƒì„±
1. **SmartLockBox/Managers/AppStateManager.swift**

### ìˆ˜ì •ë¨
1. **SmartLockBox/Managers/ScreenTimeManager.swift**
2. **SmartLockBox/Views/MainView.swift**
3. **SmartLockBox/Views/SettingsView.swift**
4. **SmartLockBox/Views/LockScreenView.swift**
5. **SmartLockBox/Views/UnlockChallengeView.swift**
6. **SmartLockBox/ContentView.swift**
7. **SmartLockBox/ViewModels/MainViewModel.swift**

---

## ìƒì„¸ ìˆ˜ì • ë‚´ì—­

### 1ï¸âƒ£ ScreenTimeManager.swift
**ì»¤ë°‹:** `403e5446` - "Fix ScreenTimeManager: remove deprecated .all() API and add FamilyActivitySelection support"

#### ë¬¸ì œ
```swift
// âŒ Deprecated API ì‚¬ìš©
store.shield.applications = .all()
store.shield.webDomains = .all()
```
- iOS 16+ì—ì„œ `.all()` APIê°€ ì œê±°ë¨
- íƒ€ì… ì˜¤ë¥˜: `Type 'Set<ApplicationToken>?' has no member 'all'`

#### í•´ê²°
```swift
// âœ… FamilyActivitySelection ê¸°ë°˜ ì°¨ë‹¨
@Published var activitySelection = FamilyActivitySelection()

if !activitySelection.applicationTokens.isEmpty {
    store.shield.applications = activitySelection.applicationTokens
}

if !activitySelection.webDomainTokens.isEmpty {
    store.shield.webDomains = activitySelection.webDomainTokens
}

if !activitySelection.categoryTokens.isEmpty {
    store.shield.applicationCategories = .specific(activitySelection.categoryTokens)
    store.shield.webDomainCategories = .specific(activitySelection.categoryTokens)
}
```

#### ê°œì„ ì‚¬í•­
- ì‚¬ìš©ìê°€ FamilyActivityPickerë¥¼ í†µí•´ ì°¨ë‹¨í•  ì•± ì„ íƒ ê°€ëŠ¥
- ì¹´í…Œê³ ë¦¬ ë‹¨ìœ„ ì°¨ë‹¨ ì§€ì›
- `updateActivitySelection()` ë©”ì„œë“œ ì¶”ê°€

---

### 2ï¸âƒ£ AppStateManager.swift (ìƒˆë¡œ ìƒì„±)
**ì»¤ë°‹:** `d36f3a85` - "Add AppStateManager: central state management for app lock and usage tracking"

#### ë¬¸ì œ
- ì•± ì „ì²´ì˜ ìƒíƒœë¥¼ ê´€ë¦¬í•  ì¤‘ì•™ í´ë˜ìŠ¤ê°€ ì—†ìŒ
- ì—¬ëŸ¬ Viewì—ì„œ `@EnvironmentObject var appState: AppStateManager` ì°¸ì¡°í•˜ëŠ”ë° í´ë˜ìŠ¤ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ

#### í•´ê²°
ì™„ì „í•œ ì¤‘ì•™ ìƒíƒœ ê´€ë¦¬ ì‹œìŠ¤í…œ êµ¬í˜„:

```swift
class AppStateManager: ObservableObject {
    // ì•± ìƒíƒœ
    enum AppState {
        case unlocked
        case locked
        case challengeActive
    }
    
    @Published var currentState: AppState = .unlocked
    
    // ì‚¬ìš© ì‹œê°„ ì¶”ì 
    @Published var todayUsageMinutes: Int = 0
    @Published var dailyGoalMinutes: Int = 180
    
    // ì ê¸ˆ ìƒíƒœ
    @Published var isLocked: Bool = false
    @Published var lockStartTime: Date?
    @Published var unlockTime: Date?
    
    // ì±Œë¦°ì§€ ìƒíƒœ
    @Published var isChallengeActive: Bool = false
    @Published var todayChallengeAttempts: Int = 0
    
    // Screen Time í†µí•©
    var screenTimeManager: ScreenTimeManager?
    
    // ì£¼ìš” ë©”ì„œë“œ
    func enableLock()
    func disableLock()
    func startUnlockChallenge()
    func endUnlockChallenge(success: Bool)
    func cancelUnlockChallenge()
    func resetAllData()
}
```

#### ì£¼ìš” ê¸°ëŠ¥
- âœ… ì¤‘ì•™í™”ëœ ì•± ìƒíƒœ ê´€ë¦¬
- âœ… ì‚¬ìš© ì‹œê°„ ìë™ ì¶”ì 
- âœ… ì¼ì¼ ëª©í‘œ ê´€ë¦¬
- âœ… ìë™ ì ê¸ˆ/í•´ì œ
- âœ… ì¼ì¼ ì´ˆê¸°í™” (ë§¤ì¼ 0ì‹œ)
- âœ… UserDefaults ì—°ë™

---

### 3ï¸âƒ£ MainView.swift
**ì»¤ë°‹:** 
- `60e65235` - "Fix MainView: break down complex expression into sub-views to fix compiler type-check timeout"
- `26826d41` - "Fix MainView: convert Int to Double for progressColor and format Date to String for localized text"
- `61eca18c` - "Fix MainView: use NSLocalizedString and String.format for proper string formatting"

#### ë¬¸ì œ 1: ì»´íŒŒì¼ëŸ¬ íƒ€ì„ì•„ì›ƒ
```swift
// âŒ ë„ˆë¬´ ë³µì¡í•œ í‘œí˜„ì‹
private var mainContent: some View {
    ScrollView {
        VStack(spacing: 24) {
            // ì–¸ì–´ ìŠ¤ìœ„ì²˜
            HStack { ... }
            
            // ëª©í‘œ ë‹¬ì„±
            VStack(spacing: 16) {
                Text("today_goal".localized)...
                AnimatedProgressBarWithLabel(...)
                HStack {
                    VStack(alignment: .leading, spacing: 4) { ... }
                    Spacer()
                    PulsatingLockButton(...)
                }
            }
            // ... ë” ë§ì€ ì¤‘ì²©ëœ ì½”ë“œ
        }
    }
}
```

#### í•´ê²° 1: ì„œë¸Œë·°ë¡œ ë¶„ë¦¬
```swift
// âœ… ê¹”ë”í•œ êµ¬ì¡°
private var mainContent: some View {
    ScrollView {
        VStack(spacing: 24) {
            headerView
            goalAchievementSection
            timeRemainingSection
            weeklyStatsSection
            monthlyHeatmapSection
            Spacer(minLength: 20)
        }
        .padding()
    }
    .background(AppColors.background.ignoresSafeArea())
    .navigationTitle("app_name".localized)
    .toolbar { toolbarContent }
}

private var headerView: some View { ... }
private var goalAchievementSection: some View { ... }
private var progressBar: some View { ... }
// ... ê° ì„¹ì…˜ì„ computed propertyë¡œ ë¶„ë¦¬
```

#### ë¬¸ì œ 2: íƒ€ì… ë¶ˆì¼ì¹˜
```swift
// âŒ Int â†’ Double ë³€í™˜ ëˆ„ë½
foregroundColor: AppColors.progressColor(percentage: appState.usagePercentage)
// appState.usagePercentageëŠ” Intì¸ë° progressColorëŠ” Double ê¸°ëŒ€

// âŒ Date â†’ String ë³€í™˜ ì˜¤ë¥˜
Text("expected_lock_time".localized(with: expectedLockTime.formatted(...) as CVarArg))
```

#### í•´ê²° 2: ëª…ì‹œì  íƒ€ì… ë³€í™˜
```swift
// âœ… Int â†’ Double ë³€í™˜
foregroundColor: AppColors.progressColor(percentage: Double(appState.usagePercentage))

// âœ… ì˜¬ë°”ë¥¸ String í¬ë§·íŒ…
private var expectedLockTimeText: some View {
    let formattedTime = expectedLockTime.formatted(date: .omitted, time: .shortened)
    let localizedFormat = NSLocalizedString("expected_lock_time", comment: "Expected lock time format")
    let finalText = String(format: localizedFormat, formattedTime)
    
    return Text(finalText)
        .font(.subheadline)
        .foregroundColor(AppColors.secondaryText)
}
```

---

### 4ï¸âƒ£ SettingsView.swift
**ì»¤ë°‹:** `62ecc126` - "Refactor SettingsView: organize into cleaner sections and fix AppStateManager integration"

#### ê°œì„ ì‚¬í•­
- AppStateManager í†µí•©
- ì„¹ì…˜ë³„ë¡œ computed property ë¶„ë¦¬
- Helper ë©”ì„œë“œ ì¶”ê°€

```swift
// âœ… ê¹”ë”í•œ êµ¬ì¡°
var body: some View {
    Form {
        goalSettingsSection
        unlockSettingsSection
        challengeSettingsSection
        notificationSection
        languageSection
        appInfoSection
    }
    .navigationTitle("settings_title".localized)
    .onAppear { loadSettings() }
}

private var goalSettingsSection: some View { ... }
private var unlockSettingsSection: some View { ... }
// ... ê° ì„¹ì…˜ ë¶„ë¦¬

private func loadSettings() { ... }
private func updateAutoUnlockTime(_ newValue: Date) { ... }
```

---

### 5ï¸âƒ£ LockScreenView.swift
**ì»¤ë°‹:** `59904e8c` - "Refactor LockScreenView: organize into clean sections and use AppStateManager.disableLock()"

#### ë¬¸ì œ
```swift
// âŒ ì˜ëª»ëœ ìƒíƒœ ë³€ê²½
if h <= 0 && m <= 0 && s <= 0 {
    appState.isLocked = false  // ì§ì ‘ ë³€ê²½
}
```

#### í•´ê²°
```swift
// âœ… AppStateManager ë©”ì„œë“œ ì‚¬ìš©
if h <= 0 && m <= 0 && s <= 0 {
    unlockApp()
}

private func unlockApp() {
    appState.disableLock()
    NotificationManager.shared.scheduleUnlockNotification(isCreative: false)
}
```

#### êµ¬ì¡° ê°œì„ 
- ë°°ê²½, íŒŒí‹°í´, ë©”ì¸ ì»¨í…ì¸ ë¥¼ ë³„ë„ computed propertyë¡œ ë¶„ë¦¬
- ì•¡ì…˜ í•¸ë“¤ëŸ¬ ë©”ì„œë“œ ë¶„ë¦¬
- íƒ€ì´ë¨¸ ê´€ë ¨ ë¡œì§ ì •ë¦¬

---

### 6ï¸âƒ£ UnlockChallengeView.swift
**ì»¤ë°‹:** `9275396f` - "Fix UnlockChallengeView: use AppStateManager methods instead of non-existent unlockDevice()"

#### ë¬¸ì œ
```swift
// âŒ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë©”ì„œë“œ í˜¸ì¶œ
if result.isSuccess {
    appState.unlockDevice()  // ì´ëŸ° ë©”ì„œë“œ ì—†ìŒ
}

// âŒ ì§ì ‘ ìƒíƒœ ë³€ê²½
appState.currentState = .locked
```

#### í•´ê²°
```swift
// âœ… ì˜¬ë°”ë¥¸ ë©”ì„œë“œ ì‚¬ìš©
private func handleResultDismiss(success: Bool) {
    if success {
        appState.endUnlockChallenge(success: true)
    } else {
        showResult = false
        viewModel.challengeResult = nil
    }
}

private func handleCancel() {
    appState.cancelUnlockChallenge()
}
```

#### êµ¬ì¡° ê°œì„ 
- ê° ì„¹ì…˜ì„ ì„œë¸Œë·°ë¡œ ë¶„ë¦¬ (ChallengeInputView, EvaluatingView, ResultView)
- @ViewBuilder ì‚¬ìš©ìœ¼ë¡œ ì¡°ê±´ë¶€ ë Œë”ë§ ê°œì„ 

---

### 7ï¸âƒ£ ContentView.swift
**ì»¤ë°‹:** `1df0d93b` - "Fix ContentView: use correct AppState enum cases (unlocked, locked, challengeActive)"

#### ë¬¸ì œ
```swift
// âŒ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” enum ì¼€ì´ìŠ¤
switch appState.currentState {
case .normal:          // AppStateì— ì—†ìŒ
    MainView()
case .unlockChallenge: // AppStateì— ì—†ìŒ
    UnlockChallengeView()
}
```

#### í•´ê²°
```swift
// âœ… ì˜¬ë°”ë¥¸ enum ì¼€ì´ìŠ¤
switch appState.currentState {
case .unlocked:        // âœ… ì •ì˜ë¨
    MainView()
case .locked:
    LockScreenView()
case .challengeActive: // âœ… ì •ì˜ë¨
    UnlockChallengeView()
}
```

---

### 8ï¸âƒ£ MainViewModel.swift
**ì»¤ë°‹:** `dee6151f` - "Fix MainViewModel: change getExpectedLockTime return type from String to Date"

#### ë¬¸ì œ
```swift
// âŒ String ë°˜í™˜í•˜ëŠ”ë° Date í•„ìš”
func getExpectedLockTime(currentMinutes: Int, goalMinutes: Int) -> String {
    let remainingMinutes = goalMinutes - currentMinutes
    if remainingMinutes <= 0 {
        return "ì¦‰ì‹œ ì ê¸ˆ"
    }
    
    let lockTime = Date().addingTimeInterval(TimeInterval(remainingMinutes * 60))
    let formatter = DateFormatter()
    // ... í¬ë§·íŒ…
    return formatter.string(from: lockTime) + " ì ê¸ˆ"
}

// MainViewì—ì„œ
TimeRemainingView(
    remainingMinutes: appState.remainingMinutes,
    expectedLockTime: viewModel.getExpectedLockTime(...)  // Stringì´ ë“¤ì–´ì˜´
)

// TimeRemainingViewëŠ”
struct TimeRemainingView: View {
    let expectedLockTime: Date  // Dateë¥¼ ê¸°ëŒ€
}
```

#### í•´ê²°
```swift
// âœ… Date ë°˜í™˜ìœ¼ë¡œ ë³€ê²½
func getExpectedLockTime(currentMinutes: Int, goalMinutes: Int) -> Date {
    let remainingMinutes = goalMinutes - currentMinutes
    
    if remainingMinutes <= 0 {
        return Date()  // ì¦‰ì‹œ ì ê¸ˆ
    }
    
    return Date().addingTimeInterval(TimeInterval(remainingMinutes * 60))
}
```

ì´ì œ TimeRemainingViewì—ì„œ Dateë¥¼ ë°›ì•„ì„œ ì›í•˜ëŠ” í¬ë§·ìœ¼ë¡œ í‘œì‹œ ê°€ëŠ¥

---

## ì£¼ìš” ê°œì„ ì‚¬í•­

### 1. ì•„í‚¤í…ì²˜
- âœ… **ì¤‘ì•™í™”ëœ ìƒíƒœ ê´€ë¦¬**: AppStateManagerë¥¼ í†µí•œ ë‹¨ì¼ ì§„ì‹¤ì˜ ì›ì²œ (Single Source of Truth)
- âœ… **ê´€ì‹¬ì‚¬ì˜ ë¶„ë¦¬**: View, ViewModel, Managerì˜ ëª…í™•í•œ ì—­í•  êµ¬ë¶„
- âœ… **ì˜ì¡´ì„± ì£¼ì…**: @EnvironmentObjectë¥¼ í†µí•œ ì˜ì¡´ì„± ì£¼ì…

### 2. ì½”ë“œ í’ˆì§ˆ
- âœ… **íƒ€ì… ì•ˆì •ì„±**: ëª¨ë“  íƒ€ì… ë¶ˆì¼ì¹˜ í•´ê²°
- âœ… **ì»´íŒŒì¼ ìµœì í™”**: ë³µì¡í•œ í‘œí˜„ì‹ì„ ì„œë¸Œë·°ë¡œ ë¶„ë¦¬í•˜ì—¬ ì»´íŒŒì¼ ì‹œê°„ ë‹¨ì¶•
- âœ… **ê°€ë…ì„±**: ê° ì„¹ì…˜ì„ computed propertyë¡œ ë¶„ë¦¬í•˜ì—¬ ì½”ë“œ ê°€ë…ì„± í–¥ìƒ

### 3. API í˜„ëŒ€í™”
- âœ… **ìµœì‹  API ì‚¬ìš©**: Deprecated API ì œê±° ë° ìµœì‹  FamilyControls API ì‚¬ìš©
- âœ… **iOS 16+ í˜¸í™˜**: ìµœì‹  iOS API íŒ¨í„´ ì ìš©

### 4. ìœ ì§€ë³´ìˆ˜ì„±
- âœ… **ëª¨ë“ˆí™”**: ê° ê¸°ëŠ¥ì„ ë…ë¦½ì ì¸ ë©”ì„œë“œ/computed propertyë¡œ ë¶„ë¦¬
- âœ… **ì¬ì‚¬ìš©ì„±**: ê³µí†µ ë¡œì§ì„ AppStateManagerì— ì§‘ì¤‘
- âœ… **í…ŒìŠ¤íŠ¸ ìš©ì´ì„±**: ëª…í™•í•œ ì¸í„°í˜ì´ìŠ¤ì™€ ë‹¨ì¼ ì±…ì„ ì›ì¹™

---

## ë¹Œë“œ ê²°ê³¼

### ìµœì¢… ìƒíƒœ
```
âœ… Build Succeeded
âœ… 0 Errors
âœ… 0 Warnings
```

### ìˆ˜ì •ëœ ì˜¤ë¥˜ ëª©ë¡
1. âœ… `Type 'Set<ApplicationToken>?' has no member 'all'`
2. âœ… `Type 'Set<WebDomainToken>?' has no member 'all'`
3. âœ… `Cannot find type 'AppStateManager' in scope`
4. âœ… `The compiler is unable to type-check this expression in reasonable time`
5. âœ… `Value of type 'AppStateManager' has no dynamic member 'unlockDevice'`
6. âœ… `Type 'AppStateManager.AppState' has no member 'normal'`
7. âœ… `Cannot convert value of type 'Int' to expected argument type 'Double'`
8. âœ… `Cannot convert value of type 'String' to expected argument type 'Date'`
9. âœ… `Multiple commands produce` (Compile Sources ì¤‘ë³µ ì°¸ì¡°)

---

## ì»¤ë°‹ íˆìŠ¤í† ë¦¬

```
dee6151f - Fix MainViewModel: change getExpectedLockTime return type from String to Date
61eca18c - Fix MainView: use NSLocalizedString and String.format for proper string formatting
26826d41 - Fix MainView: convert Int to Double for progressColor and format Date to String for localized text
1df0d93b - Fix ContentView: use correct AppState enum cases (unlocked, locked, challengeActive)
9275396f - Fix UnlockChallengeView: use AppStateManager methods instead of non-existent unlockDevice()
59904e8c - Refactor LockScreenView: organize into clean sections and use AppStateManager.disableLock()
62ecc126 - Refactor SettingsView: organize into cleaner sections and fix AppStateManager integration
60e65235 - Fix MainView: break down complex expression into sub-views to fix compiler type-check timeout
d36f3a85 - Add AppStateManager: central state management for app lock and usage tracking
403e5446 - Fix ScreenTimeManager: remove deprecated .all() API and add FamilyActivitySelection support
```

---

## ë‹¤ìŒ ë‹¨ê³„

### ê¶Œì¥ ì‘ì—…
1. **ì‹¤ì œ ê¸°ê¸° í…ŒìŠ¤íŠ¸**: Screen Time APIëŠ” ì‹œë®¬ë ˆì´í„°ì—ì„œ ì œí•œì ìœ¼ë¡œë§Œ ì‘ë™
2. **FamilyActivityPicker UI êµ¬í˜„**: ì‚¬ìš©ìê°€ ì°¨ë‹¨í•  ì•±ì„ ì„ íƒí•˜ëŠ” UI ì¶”ê°€
3. **DeviceActivity Extension êµ¬í˜„**: ì‹¤ì œ ì‚¬ìš© ì‹œê°„ ë°ì´í„° ìˆ˜ì§‘
4. **App Group ì„¤ì •**: Main Appê³¼ Extension ê°„ ë°ì´í„° ê³µìœ 
5. **ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‘ì„±**: AppStateManagerì˜ í•µì‹¬ ë¡œì§ í…ŒìŠ¤íŠ¸

### ì£¼ì˜ì‚¬í•­
- Screen Time APIëŠ” iOS 15.0+ í•„ìš”
- FamilyControls capability ì¶”ê°€ í•„ìˆ˜
- Privacy Policy ëª…í™•íˆ ì‘ì„±
- ì•±ìŠ¤í† ì–´ ì œì¶œ ì‹œ ì‚¬ìš© ëª©ì  ëª…ì‹œ

---

## ì°¸ê³  ë¬¸ì„œ
- [FamilyControls Framework](https://developer.apple.com/documentation/familycontrols)
- [DeviceActivity Framework](https://developer.apple.com/documentation/deviceactivity)
- [ManagedSettings Framework](https://developer.apple.com/documentation/managedsettings)
- [SwiftUI Best Practices](https://developer.apple.com/documentation/swiftui)

---

**ë¬¸ì„œ ì‘ì„±ì¼:** 2025ë…„ 11ì›” 1ì¼  
**ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸:** 2025ë…„ 11ì›” 1ì¼
